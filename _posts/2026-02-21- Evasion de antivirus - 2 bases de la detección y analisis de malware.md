---
title: Evasi√≥n de Antivirus 2-Bases de la detecci√≥n y analisis de malware
description: Comenzamos una serie de art√≠culos sobre m√©todos de detecci√≥n, analis√≠s y evasi√≥n de malware. 
date: 2026-02-21
categories: [evasion]
tags: [evasion, opsec, Formacion, redteam, malware, ofuscaci√≥n]     # Los tags deben estar siempre en min√∫sculas.
image:
  path: /assets/img/malware2/malware2.png
---

## 0. Punto de partida
En el [art√≠culo anterior](https://c0nfig17.com/posts/Evasion-de-antivirus-1-introduccion-a-los-m%C3%A9todos-de-detecci%C3%B3n/) comentamos como los antivirus comenzaban a separar entre lo que es malware y lo que no de manera sencilla. En este vamos a asentar los puntos b√°sicos de como se analiza una acci√≥n maliciosa e introducir al contexto del malware. Vamos a ir poco a poco comentando y ejemplificando los m√©todos principales para asentar un par de categorias y t√©rminos con los que vamos a tener que trabajar.


## 1. Detecci√≥n est√°tica
La detecci√≥n est√°tica es "as is", son el conjunto de cosas que podemos analizar con el malware una vez cae. Es decir si a mi me cae en un disco el malware que puedo hacer para observar su contenido "sin tocarlo". En ese sentido en el post anterior hemos visto dos m√©todos de los primigenios sobre la detecci√≥n est√°tica: el hash del fichero y el firmado. Ninguno de los dos son necesariamente resolutivos del problema, porque ning√∫n m√©todo es resolutivo en si mismo y definitivo. Existen m√°s m√©todos en los cuales profundizaremos como la [entrop√≠a](https://practicalsecurityanalytics.com/file-entropy/) o las consecuciones de bytes firmados por soluciones de seguridad como maliciosos, lo cual tambi√©n veremos en profundidad en adelante. La evasi√≥n de este m√©todo est√° muy documentado por [Rasta Mouse](https://github.com/rasta-mouse) y el proceso de limpieza a mano de estos bytes como documenta en [offensivedefence.co.uk](https://offensivedefence.co.uk/posts/threatcheck-ghidra/) . 

![Desktop View](/assets/img/malware2/1.png)

De manera adicional podemos realizar detecciones sobre comportamiento el cual se realiza est√°ticamente, por ejemplo podemos observar llamadas en el c√≥digo a VirtualAlloc o cuestiones similares que pueden levantar alertas. 


## 2. Detecci√≥n din√°mica
Son las que nacen del comportamiento del propio malware en su funcionamiento por tocar unos u otros componentes u ejecutar unas u otras accioens que se pueden considerar maliciosas o an√≥malas. Por ejemplo imaginemos que nuestro objetivo es realizar un [dump del proceso LSSAS](https://redcanary.com/threat-detection-report/techniques/lsass-memory/) en el que se encuentran las credenciales del usuario mediante procdump:

```text 
procdump.exe -ma lsass.exe lsass.dmp
```

Esta acci√≥n levantar√° los siguientes eventos:
- [4688](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4688) : En la generaci√≥n del proceso procdump.exe
- [4673](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4673) : por el uso de SeDebugPrivilege
- [10](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90010) :  abres LSSAS con permisos de lectura de memoria, siendo un evento de Sysmon.
- [4656](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4656) : Se solicita un acceso de un proceso a un objeto, en concreto a LSSAS. 

Todo esto ha ha realizado una serie de comportamientos que se ejecutan y son evidentemente maliciosos. Pero tambi√©n puede ser detectado por realizar llamadas a IPs las cuales no tienen buena reputaci√≥n o simplemente no tienen reputaci√≥n ¬øno?

![Desktop View](/assets/img/malware2/2.png)

Yo por mucho que llame a un instalador spotify.exe si no llama al dominio spotify.como sino a la ip 192.168.0.1 o a un dominio con mala reputaci√≥n o que se haya creado hace poco puedo sospechar. Ya depender√° del grado de inteligencia que tengas desplegada y tu capacidad de reacci√≥n, pero a primera instancia parece raro. Tambi√©n podr√≠a dudar de procesos que sacan mucha informaci√≥n hacia fuera, que tienen una comunicaci√≥n constante con el exterior, procesos con puertos desconocidos o procesos con puertos que no permito tener expuestos. <br>


## 3. Detecci√≥n por comportamiento
Seg√∫n detallaba la parte de la detecci√≥n din√°mica se ve√≠a ya que pasabamos a la detecci√≥n por comportamiento, ya que como ver√°s no son categor√≠as estancas y un mismo comportamiento o funcionalidad la puedes pillar de muchas maneras diferentes. Un ejemplo bastante entendible es el siguiente: <br>

![Desktop View](/assets/img/malware2/3.jpg)

Que narices hace un notepad conectandose a localhost ¬øEstamos locos? ¬øque es lo pr√≥ximo? ¬øMi calculadora pidiendo un caf√© en starbucks?.<br>

Al final en el comportamiento vamos a estudiar lo que es normal y lo que no, lo que tiene sentido o lo que no y a correlaccionar eventos. Por ejemplo en el post de [Covenant C2 ¬øComo funciona un Servidor de Command & Control?](https://c0nfig17.com/posts/Covenant-C2-Como-funciona-un-Servidor-de-Command-&-Control/) empezabamos a introducir conceptos y herramientas como sleep para no tener un tr√°fico recurrente y poder comunicarnos de manera puntual y solo para saber si es necesario con nuestr beacon ya que si mantenemos comunicaciones recurrentes ser√° m√°s f√°cil ser detectados. 

![Desktop View](/assets/img/malware2/4.png)

Pero tambi√©n tenemos que entender que implica un comportamiento que puede suponer una exfiltraci√≥n desde diferentes m√°quinas.

![Desktop View](/assets/img/malware2/5.png)

O ser capaz de concatenar l√≥gicamente una serie de movimientos laterales que se van reproduciendo en nuestra infraestructura poco a poco y para nada necesariamente el mismo d√≠a (o s√≠!).
![Desktop View](/assets/img/malware2/6.png)


## 4. Eventos e Indicadores de Compromiso (IoCs)
Dentro de esto como hemos ido viendo existen "eventos", lo cual es un concepto bastante claro y que atraviesa Windows "si haces esto se genera un ID". De manera te√≥rica parece sencillo, pero discernir un evento de una acci√≥n maliciosa a una acci√≥n legitima puede ser dificil y requerir un an√°lisis en profundidad. Aqu√≠ recordaros lo que se coment√≥ en el post anterior sobre que es o que no es malicioso. <br>
El concepto que puede ser nuevo en este punto es el de Indicador de Compromiso (IoC) el cual es bastante sencillo. Es una muestra de que algo es malo en base una detecci√≥n posterior. Es algo muy com√∫n que trataremos en estos post y para lo cual podemos usar un reporte mismo de [The DFIR Report](https://thedfirreport.com/2025/03/31/fake-zoom-ends-in-blacksuit-ransomware/#indicators) en el que nos detallan que tras su analisis los siguientes IoCs son maliciosos:

```text 
d3f@ckloader
http://78.47.105[.]28/manual/152/152.zip
http://78.47.105[.]28/manual/152/1522.zip

SecTopRAT
45.141.87[.]218:9000

Brute Ratel:
megupdate[.]com:443 / 5.181.159[.]31:443
administrative-manufacturer-gw.aws-usw2.cloud-ara.tyk[.]io:443

Cobalt Strike
provincial-gaiters-gw.aws-use1.cloud-ara.tyk.io:443 / 44.196.9.9:443

QDoor
88.119.167[.]239:443
143.244.146[.]183:443
```
<br>

Adem√°s en el post nos proponen reglas y mejoras, pero los IoCs son algo muy importante. Ten en cuenta que tener inteligencia suficiente como organizaci√≥n, as√≠ como que tu proveedor de EDR y soluciones que usses, tengan informaci√≥n actualizada te puede ayudar en caso de que un atacante haya cometido un error en cualquier punto y haya reutilizado un endpoint para un ataque que vas a sufrir, est√© en su c√≥digo o lo que sea. Por lo que detectar activamente llamadas a cualquiera de estos servicios desde tu infarestrctura puede ayudarte, aunque no tiene porque ser la base. De hecho en muchos analisis el IoC tras un postmortem en un incidente puede ayudarte, por ejemplo, puede que no estes detectando una salida de tr√°fico pero si hay un actor de amenazas que cuando cifra sus ficheros deposita siempre en C:\windows\ un fichero "ransologs.txt" puedes monitorizar un evento previo como es la subida de carga en las m√°quinas y la generaci√≥n de ese fichero para levantar un incidente. Son cosas que te permiten adelantarte en caso de que sea posible y que si est√°s durante el incidente te pueden ayudar a tomar acciones. 


## 5. An√°lisis y sandboxing
Cuando nos enfrentamos al analisis de un malware, custom hecho por nosotros dentor de la parte ofensiva o desde el blue team podemos encontrarnos multitud de capas de seguridad sobre el propio malware. Estas capas pueden ser en el propio despliegue, sobre los procesos de ejecuci√≥n o sobre el contenido. En general tienen que tratar no solo de ser efectivas en si mismas, sino no aumentar la facilidad de descubrir el funcionamiento del malware. Para ello existen muchas herramientas de diferentes tipos y para diferentes caus√≠sticas como la ofuscaci√≥n, cifrado, antidebuging, antianalisis, protecciones sobre comportamiento... <br>

Los Antivirus tratan de diversas maneras adelantarse al comportamiento del atacante estableciendo controles sobre el funcionamiento en el sistema y as√≠ poder determinar cuales son an√≥malos y cuales no. El problema principal desde nuestro punto es que estos m√©todos de manera intencional no son transparentes, por lo que descubrir cuales son cada uno de los pasos que se realizan en una detecci√≥n concreta es complejo y normalmente requiere de un trabajo de debuguear las t√©cnicas que utilizan y as√≠ poder saltarselas. <br>

Para poder explicar un poco su funcionamiento y visualizarlo debemos de visualizar tambi√©n el comportamiento de un malware complejo. Es por ello que vamos a exponer un poco lo que es una Sandbox. Una Sandbox es b√°sicamente una m√°quian virtual para analisis de malware la cual incluye un mont√≥n de funcionalidades preparadas para analizar comportamientos maliciosos. Personalmente suelo usar [Any Run](https://any.run/) para realizar pruebas o simplemente estudiar, aunque hay que tener en cuenta que con la versi√≥n community hay bastantes limitaciones, entre ellas una a nivel de OPSEC que es la inteligencia compartida que viene de todo lo que subas. Lo que subas es p√∫blico salvo que pagues para que no lo sea, y nadie te asegura que ellos no lo utilicen por muy provado que sea, por lo que mucho cuidado con lo que subes. En mi caso vamos a usar una muestra de [Lumma Stealer](https://bazaar.abuse.ch/sample/96ce37b257d068c8e67e50af8f52ef82afe7639346c1a44419b979eeaef840a0/) obtenida a trav√©s de Malware Bazaar para analizar su comportamiento en la sandbox. <br>

![Desktop View](/assets/img/malware2/7.png)

Comenzamos Descargando y abriendo el malware en una de las m√°quinas que nos proporciona AnyRun y clikandolo. <br>

![Desktop View](/assets/img/malware2/8.png)

Un Steeler es un malware el cual fundamentalmente busca ejecutarse en tu m√°quina, robar todo y salir corriendo. Si la detecci√≥n se hace posteriormente al Stealer "le da igual" ya que su objetivo ya lo ha conseguido. Muchas veces cuando nos encontramos stealers es en phishings que se realizan y que luego ser√°n vendidos por parte de Initial Access Brokers a terceros para realizar otras operaciones. Depende mucho del grupo y la utilidad del stealer, hay algunos que se centran en robar solo credenciales, pero otros tratan de robar sesiones activas en algunos servicios o credenciales de banco. Depende del objetivo al que se dirigen b√°sicamente. <br>

![Desktop View](/assets/img/malware2/9.png)

Un punto positivo de una sandbox es que te va a porporcionar informaci√≥n ordenada de las acciones que realiza el malware paso a paso seg√∫n vas interactuando con ello, por lo que tendr√°s facilidades para estudiar el bicho.

![Desktop View](/assets/img/malware2/10.png)

En este caso esta muestra viene perfecta para recordar una cosa muy sencilla expuesta en el [post anterior](https://c0nfig17.com/posts/Evasion-de-antivirus-1-introduccion-a-los-m%C3%A9todos-de-detecci%C3%B3n/#4-firmado-de-software)

![Desktop View](/assets/img/malware2/11.png)

Podemos ver la matriz de Mitre sobre las t√©cnicas utilizadas por el malware y vemos que encaja en concreto con lo que estamos analziando, acceso a credenciales, descubrimiento, consultas de registro. 

![Desktop View](/assets/img/malware2/12.png)

Analizando el tr√°fico podemos ver llamadas a dominios que ya han sido categorizados como maliciosos pero que podr√≠an llamarnos la atenci√≥n en un an√°lisis inicial. 

![Desktop View](/assets/img/malware2/13.png)

Tambi√©n mediante el apartado MalwareConf al ser un software ya analizado el propio Any Run nos proporciona configuraci√≥n del Lumma con los diferentes C2 a los que podr√≠a llamar. Tener varios dominios apuntando a uno o m√∫ltiples C2 es importante normalmente ya que permite hacer el malware resiliente y que si pierdes un C2 o lo banean puedas seguir operando. En este punto podemos ver de hecho dominios a los que no se ha llamado por parte del Lumma pero que podr√≠a hacerlo.

![Desktop View](/assets/img/malware2/14.png)

Tambi√©n detectamos la clave de cifrado del payload en ChaCha20 as√≠ como diferentes strings que pueden ayudar a la detecci√≥n.Tendremos un resumen dertallado de todas las acciones ejecutadas. 

![Desktop View](/assets/img/malware2/15.png)

Podemos entrar a detalle y como vemos esta versi√≥n de Lumma tiene como objetivo obtener ciptomonedas teniendo diferentes llamadas a wallets para tratar de robar su contenido.

![Desktop View](/assets/img/malware2/16.png)

Es importante tener en cuenta que en el analisis con una sandbox de un malware tienes diferentes configuraciones o acciones que ejecutar y ritmos de trabajo. Tanto la existencia o no de t√©cnicas antianalisis como tener un grado de OPSEC aceptable para desarrollar tareas de analista es relevante. En este punto hemos realizado llamadas a un C2 dando archivos a un atacante el cual va a observar esa activaci√≥n del malware. Esto puede ser un indicador para el atacante de que ha sido detectado y realizar acciones que eviten ser descubierto o rearticular su operativa. <br>

Una herramienta as√≠ nos permite ir bastante abajo para poder ver cada uno de los puntos. Por ejemplo podemos analizar el contenido de algunas de las peticiones del malware mediante Suricata IDS. <br>

![Desktop View](/assets/img/malware2/17.png)

En general hemos visto como funciona una Sandbox y como aterrizar el comportamiento de un malware real a diferentes tipos de analisis que se pueden dar. Es importante que tengamos en cuenta como se realizan este tipo de analisis no solo para realizar tareas defensivas y ayudar al blue team o para tener nociones de evasi√≥n, sino tambi√©n para poder analizar t√©cnicas reales y poder utilizarlas en nuestras operaciones ofensivas de cara a simular acciones de actores reales. En caso de que quieras revisar en concreto esta ejecuci√≥n de Any Run est√° disponible en este [link](https://app.any.run/tasks/11344a18-6dd7-45fa-ba2e-f7eb8c0cbfc6)




---
## Apoya el contenido de ciberseguridad en castellano

Si esta publicaci√≥n te ha sido √∫til y quieres apoyar mi trabajo para que contin√∫e creando m√°s contenido, aqu√≠ te dejo algunas formas de apoyar:

1. **Compartir el contenido**  üì≤
   Si crees que esta gu√≠a puede ser √∫til para otras personas, compartirla en tus redes sociales es una gran ayuda. 

2. **Donar en Ko-fi**  üíñ
   Puedes hacer una donaci√≥n r√°pida a trav√©s de Ko-fi para ayudarme a seguir publicando gu√≠as y tutoriales. ¬°Cada aportaci√≥n cuenta y es muy apreciada! 

   <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Apoya este contenido!', '#455d85', 'A0A41BO608');kofiwidget2.draw();</script> 
   
3. **Usa mi enlace de afiliado de NordVPN y NordPass para mejorar tu seguridad y apoyar la creaci√≥n de contenido**  üõ°Ô∏è
   Puedes suscribirte a [**NordVPN**](https://go.nordvpn.net/aff_c?offer_id=15&aff_id=132246&url_id=902) con un 75% de descuento y 3 meses gratis o a [**NordPass**](https://nordpass.com/special/?utm_medium=affiliate&utm_term&utm_content&utm_campaign=off488&utm_source=aff132246&aff_free) con un 53% de descuento y 3 meses gratis y mejorar tu seguridad a la vez que apoyas el contenido de ciberseguridad en espa√±ol. <br>

---

¬°Gracias por tu apoyo! üôè

![Desktop View](/assets/img/banner.png) <br>


